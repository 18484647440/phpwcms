HtmlTable=Class.refactor(HtmlTable,{options:{useKeyboard:true,classRowSelected:"table-tr-selected",classRowHovered:"table-tr-hovered",classSelectable:"table-selectable",shiftForMultiSelect:true,allowMultiSelect:true,selectable:false,selectHiddenRows:false},initialize:function(){this.previous.apply(this,arguments);if(this.occluded){return this.occluded}this.selectedRows=new Elements();if(!this.bound){this.bound={}}this.bound.mouseleave=this.mouseleave.bind(this);this.bound.clickRow=this.clickRow.bind(this);this.bound.activateKeyboard=function(){if(this.keyboard&&this.selectEnabled){this.keyboard.activate()}}.bind(this);if(this.options.selectable){this.enableSelect()}},empty:function(){this.selectNone();return this.previous()},enableSelect:function(){this.selectEnabled=true;this.attachSelects();this.element.addClass(this.options.classSelectable);return this},disableSelect:function(){this.selectEnabled=false;this.attachSelects(false);this.element.removeClass(this.options.classSelectable);return this},push:function(){var a=this.previous.apply(this,arguments);this.updateSelects();return a},toggleRow:function(a){return this[(this.isSelected(a)?"de":"")+"selectRow"](a)},selectRow:function(b,a){if(this.isSelected(b)||(!a&&!this.body.getChildren().contains(b))){return}if(!this.options.allowMultiSelect){this.selectNone()}if(!this.isSelected(b)){this.selectedRows.push(b);b.addClass(this.options.classRowSelected);this.fireEvent("rowFocus",[b,this.selectedRows]);this.fireEvent("stateChanged")}this.focused=b;document.clearSelection();return this},isSelected:function(a){return this.selectedRows.contains(a)},getSelected:function(){return this.selectedRows},getSelected:function(){return this.selectedRows},serialize:function(){var a=this.previous.apply(this,arguments)||{};if(this.options.selectable){a.selectedRows=this.selectedRows.map(function(b){return Array.indexOf(this.body.rows,b)}.bind(this))}return a},restore:function(a){if(this.options.selectable&&a.selectedRows){a.selectedRows.each(function(b){this.selectRow(this.body.rows[b])}.bind(this))}this.previous.apply(this,arguments)},deselectRow:function(b,a){if(!this.isSelected(b)||(!a&&!this.body.getChildren().contains(b))){return}this.selectedRows=new Elements(Array.from(this.selectedRows).erase(b));b.removeClass(this.options.classRowSelected);this.fireEvent("rowUnfocus",[b,this.selectedRows]);this.fireEvent("stateChanged");return this},selectAll:function(a){if(!a&&!this.options.allowMultiSelect){return}this.selectRange(0,this.body.rows.length,a);return this},selectNone:function(){return this.selectAll(true)},selectRange:function(b,a,f){if(!this.options.allowMultiSelect&&!f){return}var g=f?"deselectRow":"selectRow",e=Array.clone(this.body.rows);if(typeOf(b)=="element"){b=e.indexOf(b)}if(typeOf(a)=="element"){a=e.indexOf(a)}a=a<e.length-1?a:e.length-1;if(a<b){var d=b;b=a;a=d}for(var c=b;c<=a;c++){if(this.options.selectHiddenRows||e[c].isDisplayed()){this[g](e[c],true)}}return this},deselectRange:function(b,a){this.selectRange(b,a,true)},getSelected:function(){return this.selectedRows},enterRow:function(a){if(this.hovered){this.hovered=this.leaveRow(this.hovered)}this.hovered=a.addClass(this.options.classRowHovered)},leaveRow:function(a){a.removeClass(this.options.classRowHovered)},updateSelects:function(){Array.each(this.body.rows,function(a){var b=a.retrieve("binders");if(!b&&!this.selectEnabled){return}if(!b){b={mouseenter:this.enterRow.pass([a],this),mouseleave:this.leaveRow.pass([a],this)};a.store("binders",b)}if(this.selectEnabled){a.addEvents(b)}else{a.removeEvents(b)}},this)},shiftFocus:function(b,a){if(!this.focused){return this.selectRow(this.body.rows[0],a)}var c=this.getRowByOffset(b,this.options.selectHiddenRows);if(c===null||this.focused==this.body.rows[c]){return this}this.toggleRow(this.body.rows[c],a)},clickRow:function(a,b){var c=(a.shift||a.meta||a.control)&&this.options.shiftForMultiSelect;if(!c&&!(a.rightClick&&this.isSelected(b)&&this.options.allowMultiSelect)){this.selectNone()}if(a.rightClick){this.selectRow(b)}else{this.toggleRow(b)}if(a.shift){this.selectRange(this.rangeStart||this.body.rows[0],b,this.rangeStart?!this.isSelected(b):true);this.focused=b}this.rangeStart=b},getRowByOffset:function(e,d){if(!this.focused){return 0}var b=Array.indexOf(this.body.rows,this.focused);if((b==0&&e<0)||(b==this.body.rows.length-1&&e>0)){return null}if(d){b+=e}else{var a=0,c=0;if(e>0){while(c<e&&b<this.body.rows.length-1){if(this.body.rows[++b].isDisplayed()){c++}}}else{while(c>e&&b>0){if(this.body.rows[--b].isDisplayed()){c--}}}}return b},attachSelects:function(d){d=d!=null?d:true;var g=d?"addEvents":"removeEvents";this.element[g]({mouseleave:this.bound.mouseleave,click:this.bound.activateKeyboard});this.body[g]({"click:relay(tr)":this.bound.clickRow,"contextmenu:relay(tr)":this.bound.clickRow});if(this.options.useKeyboard||this.keyboard){if(!this.keyboard){this.keyboard=new Keyboard()}if(!this.selectKeysDefined){this.selectKeysDefined=true;var f,e;var c=function(i){var h=function(j){clearTimeout(f);j.preventDefault();var k=this.body.rows[this.getRowByOffset(i,this.options.selectHiddenRows)];if(j.shift&&k&&this.isSelected(k)){this.deselectRow(this.focused);this.focused=k}else{if(k&&(!this.options.allowMultiSelect||!j.shift)){this.selectNone()}this.shiftFocus(i,j)}if(e){f=h.delay(100,this,j)}else{f=(function(){e=true;h(j)}).delay(400)}}.bind(this);return h}.bind(this);var b=function(){clearTimeout(f);e=false};this.keyboard.addEvents({"keydown:shift+up":c(-1),"keydown:shift+down":c(1),"keyup:shift+up":b,"keyup:shift+down":b,"keyup:up":b,"keyup:down":b});var a="";if(this.options.allowMultiSelect&&this.options.shiftForMultiSelect&&this.options.useKeyboard){a=" (Shift multi-selects)."}this.keyboard.addShortcuts({"Select Previous Row":{keys:"up",shortcut:"up arrow",handler:c(-1),description:"Select the previous row in the table."+a},"Select Next Row":{keys:"down",shortcut:"down arrow",handler:c(1),description:"Select the next row in the table."+a}})}this.keyboard[d?"activate":"deactivate"]()}this.updateSelects()},mouseleave:function(){if(this.hovered){this.leaveRow(this.hovered)}}});