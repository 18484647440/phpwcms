//MooTools More, <http://mootools.net/more>. Copyright (c) 2006-2009 Aaron Newton <http://clientcide.com/>, Valerio Proietti <http://mad4milk.net> & the MooTools team <http://mootools.net/developers>, MIT Style License.

HtmlTable=Class.refactor(HtmlTable,{options:{useKeyboard:true,classRowSelected:"table-tr-selected",classRowHovered:"table-tr-hovered",classSelectable:"table-selectable",allowMultiSelect:true,selectable:false},initialize:function(){this.previous.apply(this,arguments);if(this.occluded){return this.occluded}this.selectedRows=new Elements();this.bound={mouseleave:this.mouseleave.bind(this),focusRow:this.focusRow.bind(this)};if(this.options.selectable){this.enableSelect()}},enableSelect:function(){this.selectEnabled=true;this.attachSelects();this.element.addClass(this.options.classSelectable)},disableSelect:function(){this.selectEnabled=false;this.attach(false);this.element.removeClass(this.options.classSelectable)},attachSelects:function(a){a=$pick(a,true);var b=a?"addEvents":"removeEvents";this.element[b]({mouseleave:this.bound.mouseleave});this.body[b]({"click:relay(tr)":this.bound.focusRow});if(this.options.useKeyboard||this.keyboard){if(!this.keyboard){this.keyboard=new Keyboard({events:{down:function(c){c.preventDefault();this.shiftFocus(1)}.bind(this),up:function(c){c.preventDefault();this.shiftFocus(-1)}.bind(this),enter:function(c){c.preventDefault();if(this.hover){this.focusRow(this.hover)}}.bind(this)},active:true})}this.keyboard[a?"activate":"deactivate"]()}this.updateSelects()},mouseleave:function(){if(this.hover){this.leaveRow(this.hover)}},focus:function(){if(this.keyboard){this.keyboard.activate()}},blur:function(){if(this.keyboard){this.keyboard.deactivate()}},push:function(){var a=this.previous.apply(this,arguments);this.updateSelects();return a},updateSelects:function(){Array.each(this.body.rows,function(a){var b=a.retrieve("binders");if((b&&this.selectEnabled)||(!b&&!this.selectEnabled)){return}if(!b){b={mouseenter:this.enterRow.bind(this,[a]),mouseleave:this.leaveRow.bind(this,[a])};a.store("binders",b).addEvents(b)}else{a.removeEvents(b)}},this)},enterRow:function(a){if(this.hover){this.hover=this.leaveRow(this.hover)}this.hover=a.addClass(this.options.classRowHovered)},shiftFocus:function(a){if(!this.hover){return this.enterRow(this.body.rows[0])}var b=Array.indexOf(this.body.rows,this.hover)+a;if(b<0){b=0}if(b>=this.body.rows.length){b=this.body.rows.length-1}if(this.hover==this.body.rows[b]){return this}this.enterRow(this.body.rows[b])},leaveRow:function(a){a.removeClass(this.options.classRowHovered)},focusRow:function(){var b=arguments[1]||arguments[0];if(!this.body.getChildren().contains(b)){return}var a=function(c){this.selectedRows.erase(c);c.removeClass(this.options.classRowSelected);this.fireEvent("rowUnfocus",[c,this.selectedRows])}.bind(this);if(!this.options.allowMultiSelect){this.selectedRows.each(a)}if(!this.selectedRows.contains(b)){this.selectedRows.push(b);b.addClass(this.options.classRowSelected);this.fireEvent("rowFocus",[b,this.selectedRows])}else{a(b)}return false},selectAll:function(a){a=$pick(a,true);if(!this.options.allowMultiSelect&&a){return}if(!a){this.selectedRows.removeClass(this.options.classRowSelected).empty()}else{this.selectedRows.combine(this.body.rows).addClass(this.options.classRowSelected)}return this},selectNone:function(){return this.selectAll(false)}});