(function(){var a={};var b=["shift","control","alt","meta"];var d=/^(?:shift|control|ctrl|alt|meta)$/;var e=function(i,h){i=i.toLowerCase().replace(/^(keyup|keydown):/,function(l,k){h=k;return""});if(!a[i]){var g="",j={};i.split("+").each(function(k){if(d.test(k)){j[k]=true}else{g=k}});j.control=j.control||j.ctrl;var f="";b.each(function(k){if(j[k]){f+=k+"+"}});a[i]=f+g}return h+":"+a[i]};this.Keyboard=new Class({Extends:Events,Implements:[Options,Log],options:{defaultEventType:"keydown",active:false,events:{}},initialize:function(f){this.setOptions(f);if(Keyboard.manager){Keyboard.manager.manage(this)}this.setup()},setup:function(){this.addEvents(this.options.events);if(this.options.active){this.activate()}},handle:function(h,g){if(!this.active||h.preventKeyboardPropagation){return}var f=!!this.manager;if(f&&this.activeKB){this.activeKB.handle(h,g);if(h.preventKeyboardPropagation){return}}this.fireEvent(g,h);if(!f&&this.activeKB){this.activeKB.handle(h,g)}},addEvent:function(h,g,f){return this.parent(e(h,this.options.defaultEventType),g,f)},removeEvent:function(g,f){return this.parent(e(g,this.options.defaultEventType),f)},activate:function(){this.active=true;return this.enable()},deactivate:function(){this.active=false;return this.fireEvent("deactivate")},toggleActive:function(){return this[this.active?"deactivate":"activate"]()},enable:function(f){if(f){if(f!=this.activeKB){this.previous=this.activeKB}this.activeKB=f.fireEvent("activate")}else{if(this.manager){this.manager.enable(this)}}return this},relenquish:function(){if(this.previous){this.enable(this.previous)}},manage:function(f){if(f.manager){f.manager.drop(f)}this.instances.push(f);f.manager=this;if(!this.activeKB){this.enable(f)}else{this._disable(f)}},_disable:function(f){if(this.activeKB==f){this.activeKB=null}},drop:function(f){this._disable(f);this.instances.erase(f)},instances:[],trace:function(){this.enableLog();var f=this;this.log("the following items have focus: ");while(f){this.log(document.id(f.widget)||f.widget||f,"active: "+this.active);f=f.activeKB}}});Keyboard.stop=function(f){f.preventKeyboardPropagation=true};Keyboard.manager=new this.Keyboard({active:true});Keyboard.trace=function(){Keyboard.manager.trace()};var c=function(g){var f="";b.each(function(h){if(g[h]){f+=h+"+"}});Keyboard.manager.handle(g,g.type+":"+f+g.key)};document.addEvents({keyup:c,keydown:c});Event.Keys.extend({pageup:33,pagedown:34,end:35,home:36,capslock:20,numlock:144,scrolllock:145})})();