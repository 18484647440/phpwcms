HtmlTable=Class.refactor(HtmlTable,{options:{sortIndex:0,sortReverse:false,parsers:[],defaultParser:"string",classSortable:"table-sortable",classHeadSort:"table-th-sort",classHeadSortRev:"table-th-sort-rev",classNoSort:"table-th-nosort",classGroupHead:"table-tr-group-head",classGroup:"table-tr-group",classCellSort:"table-td-sort",classSortSpan:"table-th-sort-span",sortable:false,thSelector:"th"},initialize:function(){this.previous.apply(this,arguments);if(this.occluded){return this.occluded}this.sorted={index:null,dir:1};this.bound={headClick:this.headClick.bind(this)};this.sortSpans=new Elements();if(this.options.sortable){this.enableSort();if(this.options.sortIndex!=null){this.sort(this.options.sortIndex,this.options.sortReverse)}}},attachSorts:function(a){this.detachSorts();if(a!==false){this.element.addEvent("click:relay("+this.options.thSelector+")",this.bound.headClick)}},detachSorts:function(){this.element.removeEvents("click:relay("+this.options.thSelector+")")},setHeaders:function(){this.previous.apply(this,arguments);if(this.sortEnabled){this.setParsers()}},setParsers:function(){this.parsers=this.detectParsers()},detectParsers:function(){return this.head&&this.head.getElements(this.options.thSelector).flatten().map(this.detectParser,this)},detectParser:function(a,b){if(a.hasClass(this.options.classNoSort)||a.retrieve("htmltable-parser")){return a.retrieve("htmltable-parser")}var c=new Element("div");c.adopt(a.childNodes).inject(a);var f=new Element("span",{"class":this.options.classSortSpan}).inject(c,"top");this.sortSpans.push(f);var g=this.options.parsers[b],e=this.body.rows,d;switch(typeOf(g)){case"function":g={convert:g};d=true;break;case"string":g=g;d=true;break}if(!d){HtmlTable.ParserPriority.some(function(k){var o=HtmlTable.Parsers[k],m=o.match;if(!m){return false}for(var n=0,l=e.length;n<l;n++){var h=document.id(e[n].cells[b]),p=h?h.get("html").clean():"";if(p&&m.test(p)){g=o;return true}}})}if(!g){g=this.options.defaultParser}a.store("htmltable-parser",g);return g},headClick:function(b,a){if(!this.head||a.hasClass(this.options.classNoSort)){return}return this.sort(Array.indexOf(this.head.getElements(this.options.thSelector).flatten(),a)%this.body.rows[0].cells.length)},serialize:function(){var a=this.previous.apply(this,arguments)||{};if(this.options.sortable){a.sortIndex=this.sorted.index;a.sortReverse=this.sorted.reverse}return a},restore:function(a){if(this.options.sortable&&a.sortIndex){this.sort(a.sortIndex,a.sortReverse)}this.previous.apply(this,arguments)},setSortedState:function(b,a){if(a!=null){this.sorted.reverse=a}else{if(this.sorted.index==b){this.sorted.reverse=!this.sorted.reverse}else{this.sorted.reverse=this.sorted.index==null}}if(b!=null){this.sorted.index=b}},setHeadSort:function(a){var b=$$(!this.head.length?this.head.cells[this.sorted.index]:this.head.map(function(c){return c.getElements(this.options.thSelector)[this.sorted.index]},this).clean());if(!b.length){return}if(a){b.addClass(this.options.classHeadSort);if(this.sorted.reverse){b.addClass(this.options.classHeadSortRev)}else{b.removeClass(this.options.classHeadSortRev)}}else{b.removeClass(this.options.classHeadSort).removeClass(this.options.classHeadSortRev)}},setRowSort:function(b,a){var e=b.length,d=this.body,g,f;while(e){var h=b[--e],c=h.position,i=d.rows[c];if(i.disabled){continue}if(!a){g=this.setGroupSort(g,i,h);this.setRowStyle(i,e)}d.appendChild(i);for(f=0;f<e;f++){if(b[f].position>c){b[f].position--}}}},setRowStyle:function(b,a){this.previous(b,a);b.cells[this.sorted.index].addClass(this.options.classCellSort)},setGroupSort:function(b,c,a){if(b==a.value){c.removeClass(this.options.classGroupHead).addClass(this.options.classGroup)}else{c.removeClass(this.options.classGroup).addClass(this.options.classGroupHead)}return a.value},getParser:function(){var a=this.parsers[this.sorted.index];return typeOf(a)=="string"?HtmlTable.Parsers[a]:a},sort:function(c,b,e){if(!this.head){return}if(!e){this.clearSort();this.setSortedState(c,b);this.setHeadSort(true)}var f=this.getParser();if(!f){return}var a;if(!Browser.ie){a=this.body.getParent();this.body.dispose()}var d=this.parseData(f).sort(function(h,g){if(h.value===g.value){return 0}return h.value>g.value?1:-1});if(this.sorted.reverse==(f==HtmlTable.Parsers["input-checked"])){d.reverse(true)}this.setRowSort(d,e);if(a){a.grab(this.body)}this.fireEvent("stateChanged");return this.fireEvent("sort",[this.body,this.sorted.index])},parseData:function(a){return Array.map(this.body.rows,function(d,b){var c=a.convert.call(document.id(d.cells[this.sorted.index]));return{position:b,value:c}},this)},clearSort:function(){this.setHeadSort(false);this.body.getElements("td").removeClass(this.options.classCellSort)},reSort:function(){if(this.sortEnabled){this.sort.call(this,this.sorted.index,this.sorted.reverse)}return this},enableSort:function(){this.element.addClass(this.options.classSortable);this.attachSorts(true);this.setParsers();this.sortEnabled=true;return this},disableSort:function(){this.element.removeClass(this.options.classSortable);this.attachSorts(false);this.sortSpans.each(function(a){a.destroy()});this.sortSpans.empty();this.sortEnabled=false;return this}});HtmlTable.ParserPriority=["date","input-checked","input-value","float","number"];HtmlTable.Parsers={date:{match:/^\d{2}[-\/ ]\d{2}[-\/ ]\d{2,4}$/,convert:function(){var a=Date.parse(this.get("text").stripTags());return(typeOf(a)=="date")?a.format("db"):""},type:"date"},"input-checked":{match:/ type="(radio|checkbox)" /,convert:function(){return this.getElement("input").checked}},"input-value":{match:/<input/,convert:function(){return this.getElement("input").value}},number:{match:/^\d+[^\d.,]*$/,convert:function(){return this.get("text").stripTags().toInt()},number:true},numberLax:{match:/^[^\d]+\d+$/,convert:function(){return this.get("text").replace(/[^-?^0-9]/,"").stripTags().toInt()},number:true},"float":{match:/^[\d]+\.[\d]+/,convert:function(){return this.get("text").replace(/[^-?^\d.]/,"").stripTags().toFloat()},number:true},floatLax:{match:/^[^\d]+[\d]+\.[\d]+$/,convert:function(){return this.get("text").replace(/[^-?^\d.]/,"").stripTags()},number:true},string:{match:null,convert:function(){return this.get("text").stripTags().toLowerCase()}},title:{match:null,convert:function(){return this.title}}};HtmlTable.Parsers=new Hash(HtmlTable.Parsers);HtmlTable.defineParsers=function(a){HtmlTable.Parsers=Object.append(HtmlTable.Parsers,a);for(var b in a){HtmlTable.ParserPriority.unshift(b)}};